/**
 * Lyt Analytics v0.1.0
 * Lightweight analytics for Phoenix applications
 */
(function () {
  "use strict";
  var e = {
      endpoint: "/api/analytics",
      autoPageview: !0,
      hashRouting: !1,
      spaMode: !0,
      flushInterval: 1e3,
      debug: !1,
    },
    t = [],
    n = null,
    o = null,
    a = !1;
  function i(t) {
    e.debug &&
      console &&
      console.log &&
      console.log("[Lyt]", t, arguments[1] || "");
  }
  function r() {
    return "file:" === location.protocol
      ? (i("Skipping: file protocol"), !1)
      : window._phantom ||
          window.__nightmare ||
          window.navigator.webdriver ||
          window.Cypress
        ? (i("Skipping: automation detected"), !1)
        : !(function () {
            try {
              if (
                window.localStorage &&
                "true" === window.localStorage.lyt_ignore
              )
                return (i("Skipping: localStorage opt-out"), !0);
            } catch (e) {}
            return !1;
          })();
  }
  function s(t, n) {
    var o = {
      name: t,
      path: (n = n || {}).path || location.pathname,
      hostname: n.hostname || location.hostname,
      query: n.query || location.search.substring(1),
    };
    if ((n.metadata && (o.metadata = n.metadata), !a)) {
      ((o.screen_width =
        window.innerWidth || document.documentElement.clientWidth),
        (o.screen_height =
          window.innerHeight || document.documentElement.clientHeight));
      var i = new URLSearchParams(location.search);
      (i.get("utm_source") && (o.utm_source = i.get("utm_source")),
        i.get("utm_medium") && (o.utm_medium = i.get("utm_medium")),
        i.get("utm_campaign") && (o.utm_campaign = i.get("utm_campaign")),
        i.get("utm_term") && (o.utm_term = i.get("utm_term")),
        i.get("utm_content") && (o.utm_content = i.get("utm_content")),
        (a = !0));
    }
    return o;
  }
  function c(e, n, o) {
    r()
      ? (t.push({ payload: s(e, n), callback: o }), i("Queued:", e), u())
      : o && o({ ignored: !0 });
  }
  function u() {
    n ||
      (n = setTimeout(function () {
        ((n = null), l());
      }, e.flushInterval));
  }
  function l(o) {
    if (0 === t.length)
      return (i("Queue empty"), void (o && o({ ok: !0, queued: 0 })));
    var a = t.slice(),
      r = a
        .map(function (e) {
          return e.callback;
        })
        .filter(Boolean);
    ((t = []), n && (clearTimeout(n), (n = null)));
    var s = a.map(function (e) {
      return e.payload;
    });
    i("Flushing " + s.length + " events");
    var c = e.endpoint + "/events";
    window.fetch
      ? fetch(c, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          keepalive: !0,
          body: JSON.stringify({ events: s }),
        })
          .then(function (e) {
            return e.json();
          })
          .then(function (e) {
            (i("Flush complete:", e),
              r.forEach(function (t) {
                t(e);
              }),
              o && o(e));
          })
          .catch(function (e) {
            i("Flush error:", e);
            var t = { error: e };
            (r.forEach(function (e) {
              e(t);
            }),
              o && o(t));
          })
      : (function (e, t, n) {
          var o = new XMLHttpRequest();
          (o.open("POST", e, !0),
            o.setRequestHeader("Content-Type", "application/json"),
            (o.onreadystatechange = function () {
              if (4 === o.readyState) {
                var e;
                ((e =
                  o.status >= 200 && o.status < 300
                    ? (function () {
                        try {
                          return JSON.parse(o.responseText);
                        } catch (e) {
                          return { ok: !0 };
                        }
                      })()
                    : { error: o.status }),
                  n && n(e));
              }
            }),
            o.send(JSON.stringify(t)));
        })(c, { events: s }, function (e) {
          (r.forEach(function (t) {
            t(e);
          }),
            o && o(e));
        });
  }
  function d(t) {
    var n = e.hashRouting
      ? location.pathname + location.hash
      : location.pathname;
    (t && t.checkDuplicate && o === n) || ((o = n), c("Page View", t));
  }
  function f(e, t, n) {
    ("function" == typeof t && ((n = t), (t = {})), c(e, t, n));
  }
  (!(function () {
    for (
      var t = document.getElementsByTagName("script"), n = 0;
      n < t.length;
      n++
    ) {
      var o = t[n];
      if (o.src && -1 !== o.src.indexOf("lyt")) {
        (o.dataset.api && (e.endpoint = o.dataset.api),
          "false" === o.dataset.auto && (e.autoPageview = !1),
          "true" === o.dataset.hash && (e.hashRouting = !0),
          "false" === o.dataset.spa && (e.spaMode = !1),
          o.dataset.interval &&
            (e.flushInterval = parseInt(o.dataset.interval, 10) || 1e3),
          "true" === o.dataset.debug && (e.debug = !0));
        break;
      }
    }
  })(),
    (function () {
      if (e.autoPageview) {
        if (e.spaMode && window.history && window.history.pushState) {
          var t = history.pushState;
          ((history.pushState = function () {
            (t.apply(this, arguments), d({ checkDuplicate: !0 }));
          }),
            window.addEventListener("popstate", function () {
              d({ checkDuplicate: !0 });
            }));
        }
        (e.hashRouting &&
          window.addEventListener("hashchange", function () {
            d({ checkDuplicate: !0 });
          }),
          "visible" === document.visibilityState
            ? d()
            : document.addEventListener("visibilitychange", function () {
                "visible" !== document.visibilityState || null !== o || d();
              }),
          window.addEventListener("pageshow", function (e) {
            e.persisted && d();
          }));
      } else i("Auto pageview disabled");
    })(),
    window.addEventListener("pagehide", function () {
      t.length > 0 && l();
    }),
    document.addEventListener("visibilitychange", function () {
      "hidden" === document.visibilityState && t.length > 0 && l();
    }),
    (f.flush = function (e) {
      l(e);
    }),
    (f.pageview = function (e) {
      d(e);
    }),
    (f.configure = function (t) {
      (t.endpoint && (e.endpoint = t.endpoint),
        void 0 !== t.autoPageview && (e.autoPageview = t.autoPageview),
        void 0 !== t.hashRouting && (e.hashRouting = t.hashRouting),
        void 0 !== t.spaMode && (e.spaMode = t.spaMode),
        void 0 !== t.flushInterval && (e.flushInterval = t.flushInterval),
        void 0 !== t.debug && (e.debug = t.debug));
    }),
    (f.queueLength = function () {
      return t.length;
    }),
    (f.optOut = function () {
      try {
        window.localStorage && (window.localStorage.lyt_ignore = "true");
      } catch (e) {}
    }),
    (f.optIn = function () {
      try {
        window.localStorage && delete window.localStorage.lyt_ignore;
      } catch (e) {}
    }),
    (f.version = "0.1.0"));
  var p = window.lyt && window.lyt.q;
  if (p && Array.isArray(p))
    for (var g = 0; g < p.length; g++) f.apply(null, p[g]);
  window.lyt = f;
})();
